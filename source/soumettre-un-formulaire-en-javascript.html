<!DOCTYPE html>
<html lang="fr-FR">
<title>Soumettre un formulaire en JavaScript</title>
<meta name="viewport" content="width=device-width">
<link rel="icon" href="assets/favicon.svg" type="image/svg+xml">
<link rel="stylesheet" href="assets/common.css">
<link rel="stylesheet" href="assets/article.css">
<h1>Soumettre un formulaire en JavaScript</h1>
<h2><abbr lang="en" title="Too Long; Didnâ€™t Read">TL;DR</abbr></h2>
<link rel="stylesheet" href="assets/code.css">
<pre><code class=" source.js">form.dispatchEvent(new Event("submit", { bubbles: true, cancelable: true }))
    && form.reportValidity()
    && form.submit();</code></pre>
<h2><abbr lang="en" title="Too Long; Read Anyway">TL;RA</abbr></h2>
<p>
    Le besoin Ã©tait simpleÂ : inclure <a href="https://developers.google.com/recaptcha/docs/v3" hreflang="en">reCAPTCHA v3</a>
    sur des formulaires de contact. Ã€ leur soumission, on leur ajoute un token qui pourra Ãªtre utilisÃ© par le backend
    pour estimer la lÃ©gitimitÃ© de lâ€™interaction. Certains formulaires sont soumis par le navigateur, et dâ€™autres via
    <a href="https://developer.mozilla.org/fr/docs/Web/API/Fetch_API"><code>fetch</code></a>. Pour Ãªtre sÃ»r dâ€™ajouter le
    token en premier, on va donc Ã©couter lâ€™Ã©vÃ©nement
    <a href="https://developer.mozilla.org/fr/docs/Web/API/HTMLFormElement/submit_event"><code>submit</code></a> sur
    <code>window</code> pendant
    <a href="https://javascript.info/bubbling-and-capturing#capturing" hreflang="en">la phase de capture</a>.
</p>
<pre><code class=" source.js">window.addEventListener("submit", includeReCaptchaToken, true);</code></pre>
<p>
    Le token est obtenu via une
    <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Global_Objects/Promise"><code>Promise</code></a>.
    Le temps quâ€™elle soit rÃ©solue il faut donc empÃªcher
</p>
<ol>
    <li>le formulaire dâ€™Ãªtre soumis par le navigateur</li>
    <li>tout Ã©couteur de rÃ©agir Ã  lâ€™Ã©vÃ©nement <code>submit</code></li>
</ol>
<p>On peut ensuite attendre le token et lâ€™ajouter au formulaire, puis soumettre ce dernier.</p>
<pre><code class=" source.js">function includeReCaptchaToken(e) {
    /* 1. */ e.preventDefault();
    /* 2. */ e.stopImmediatePropagation();

    const form = e.target;

    grecaptcha.execute("_reCAPTCHA_site_key_", { action: "contact" }).then(function(token) {
        form.querySelector("[name=recaptcha-token]").value = token;

        submitForm(form); // ğŸ¤”
    });
}</code></pre>
<p>
    Tout formulaire dispose dâ€™une mÃ©thode
    <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLFormElement/submit" hreflang="en"><code>submit</code></a>.
    Seulementâ€¦ celle-ci <strong>ne dÃ©clenche pas lâ€™Ã©vÃ©nement
    <code>submit</code></strong>, et <strong>ne valide pas le formulaire</strong>â€¯; il va falloir le faire nous-mÃªmeâ€¯!
</p>
<h3>DÃ©clencher lâ€™Ã©vÃ©nement <code>submit</code></h3>
<p>
    Câ€™est la premiÃ¨re chose Ã  faire, car si cet Ã©vÃ©nement est annulÃ© par un Ã©couteur on doit lui laisser le gÃ©rer.
    Nous allons donc crÃ©er notre version la plus fidÃ¨le de lâ€™Ã©vÃ©nement natif,Â qui bouillonne en plus dâ€™Ãªtre annulableÂ :
</p>
<pre><code class=" source.js">const event = new Event("submit", {
    bubbles: true,
    cancelable: true,
});
</code></pre>
<p>
    Un Ã©vÃ©nement peut Ãªtre envoyÃ© par toute cible potentielle â€”â€¯et donc notre formulaireâ€¯â€” grÃ¢ce Ã  la mÃ©thode
    <a href="https://developer.mozilla.org/fr/docs/Web/API/EventTarget/dispatchEvent"><code>dispatchEvent</code></a>.
    Cette derniÃ¨re appelera tous les Ã©couteurs de maniÃ¨re synchrone, ce qui lui permet de retourner <code>false</code>
    si au moins un a annulÃ© lâ€™Ã©vÃ©nement. Dans ce cas, le formulaire ne doit pas Ãªtre soumis et notre fonction
    <code>submitForm</code> peut retourner.
</p>
<pre><code class=" source.js">if (!form.dispatchEvent(event)) {
    return;
}
</code></pre>
<h3>Valider le formulaire</h3>
<p>
    Nous allons simplement utiliser la mÃ©thode
    <a href="https://developer.mozilla.org/fr/docs/Web/API/HTMLFormElement/reportValidity"><code>reportValidity</code></a>
    du formulaire. En cas dâ€™Ã©chec, elle retournera <code>false</code> et signalera les erreurs Ã  lâ€™utilisateur. Inutile
    alors de soumettre le formulaire.
</p>
<pre><code class=" source.js">if (!form.reportValidity()) {
    return;
}
</code></pre>
<h3>Soumettre le formulaire</h3>
<p>
    Jâ€™espÃ¨re que vous nâ€™avez pas oubliÃ© la mÃ©thode <code>submit</code> du formulaireâ€¯; câ€™est tout ce quâ€™il nous reste Ã 
    faireâ€¯! Empilons les blocs de code ci-dessus pour implÃ©menter <code>submitForm</code>Â :
</p>
<pre><code class=" source.js">function submitForm(form) {
    const event = new Event("submit", {
        bubbles: true,
        cancelable: true,
    });

    if (!form.dispatchEvent(event)) {
        return;
    }

    if (!form.reportValidity()) {
        return;
    }

    form.submit();
}
</code></pre>
<p>
    Si vous prÃ©fÃ©rez les <i lang="en">one-liners</i>, vous pouvez retrouver une version plus concise
    <a href="#TL%3BDR">en haut de cet article</a>.
</p>
</html>
